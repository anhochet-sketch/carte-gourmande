<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carte gourmande ‚Äî Satellite + labels (ü•® sal√© / üçØ sucr√©)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin>
<style>
:root { --bg:#fff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; }
* { box-sizing:border-box; } html,body { height:100%; }
body { margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; color:#111827; background:#fff;}
header { padding:12px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
h1 { font-size:20px; margin:0; } .muted { color:var(--muted); font-size:13px; }
.search { display:flex; gap:8px; padding:8px 16px; }
input[type=search] { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:12px; }
button.clear { padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#f9fafb; }
.content { display:grid; grid-template-columns:1fr 2fr; gap:16px; padding:0 16px 16px; }
#mapCard,#listCard { border:1px solid var(--border); border-radius:16px; overflow:hidden; position:relative; background:#fff; }
#map { width:100%; height:100%; min-height:80vh; }
.legend { position:absolute; left:10px; bottom:10px; background:rgba(255,255,255,.9); padding:8px 10px; border-radius:10px; border:1px solid var(--border); font-size:12px; display:flex; gap:10px; align-items:center; }
.legend .chip { display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); }
.legend .emoji { font-size:14px; }
.debug { position:absolute; right:10px; top:10px; background:rgba(255,255,255,.9); padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:11px; }
.list { height: calc(100vh - 260px); overflow-y:auto; }
.card { display:flex; gap:12px; padding:12px; align-items:center; border-bottom:1px solid var(--border); cursor:pointer; }
.thumb { width:76px; height:76px; border-radius:12px; object-fit:cover; background:#eee; }
.title { font-weight:600; font-size:15px; }
.desc { color:var(--muted); font-size:12px; margin-top:4px; }
footer { padding:10px 16px; font-size:11px; color:#6b7280; }
@media (max-width: 900px) { .content { grid-template-columns:1fr; gap:12px; } #map { min-height:72vh; } .list { height:auto; max-height:56vh; } }

/* === Ic√¥nes de carte en CSS + emoji (petites bulles) === */
.leaflet-div-icon { background: transparent; border: none; }
.pin {
  position: relative;
  width: 22px; height: 22px;           /* ‚Üê taille des bulles (augmente/diminue ici) */
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #111827;
  font-size: 13px;                     /* ‚Üê taille de l'emoji */
  line-height: 1;
  border: 2px solid;
  box-shadow: 0 1px 3px rgba(0,0,0,.25);
}
.pin::after {                          /* petite pointe du pin */
  content: "";
  position: absolute;
  bottom: -7px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 7px solid;
  filter: drop-shadow(0 1px 1px rgba(0,0,0,.15));
}
.pin.savory {                          /* Sal√© = ü•® (bleu) */
  background: #dbeafe;
  border-color: #3b82f6;
}
.pin.savory::after { border-top-color: #3b82f6; }
.pin.sweet {                           /* Sucr√© = üçØ (miel/orang√©) */
  background: #fff7ed;
  border-color: #f59e0b;
}
.pin.sweet::after { border-top-color: #f59e0b; }
</style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <img src="https://upload.wikimedia.org/wikipedia/commons/2/26/Emoji_u1f60b.svg" alt="Logo" style="height:28px">
      <div>
        <h1>Carte gourmande</h1>
        <div class="muted">Satellite Esri + labels de villes ‚Äî ü•® Sal√© / üçØ Sucr√©</div>
      </div>
    </div>
  </header>

  <div class="search">
    <input id="q" type="search" placeholder="Rechercher une sp√©cialit√©, une ville, un mot-cl√©‚Ä¶" aria-label="Recherche">
    <button class="clear" id="clearBtn">Effacer</button>
  </div>

  <div class="content">
    <section id="mapCard">
      <div id="map" role="region" aria-label="Carte des sp√©cialit√©s"></div>
      <div class="legend">
        <span class="chip"><span class="emoji">ü•®</span> Sal√©</span>
        <span class="chip"><span class="emoji">üçØ</span> Sucr√©</span>
      </div>
      <div class="debug" id="dbg">chargement‚Ä¶</div>
    </section>
    <section id="listCard">
      <div class="list" id="list"></div>
    </section>
  </div>

  <footer>Liens affili√©s (publicit√©). En tant que Partenaire, je r√©alise un b√©n√©fice sur les achats remplissant les conditions requises.</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin></script>

  <!-- Donn√©es -->
  <script src="/data.js?v=14"></script>

  <script>
  (function(){
    const dbg = document.getElementById('dbg');

    function waitForData(maxMs=4000){
      return new Promise((resolve,reject)=>{
        const started = Date.now();
        (function loop(){
          if (Array.isArray(window.FULL_DATA)) return resolve(window.FULL_DATA);
          if (Date.now() - started > maxMs) return reject(new Error('FULL_DATA introuvable'));
          requestAnimationFrame(loop);
        })();
      });
    }
    function toNum(v){
      if (typeof v === 'number' && isFinite(v)) return v;
      if (typeof v === 'string'){
        const n = parseFloat(v.replace(',', '.').trim());
        if (isFinite(n)) return n;
      }
      return null;
    }
    function safeImg(u){
      if (!u) return '';
      if (typeof u !== 'string') return '';
      if (u.startsWith('http://')) return 'https://images.weserv.nl/?url=' + encodeURIComponent(u.replace(/^http:\/\//,''));
      return u;
    }
    function normalizeRow(r){
      if (!r || typeof r !== 'object') return null;
      const lat = toNum(r.latitude ?? r.lat ?? r.lattitude ?? r.Latitude ?? r.Lat ?? r.y ?? r.Y);
      const lon = toNum(r.longitude ?? r.lon ?? r.lng ?? r.Longitude ?? r.Lng ?? r.x ?? r.X);
      if (lat == null || lon == null) return null;
      const name = r.name ?? r.NOM ?? r.titre ?? r.title ?? '';
      const desc = r.description ?? r.DESCRIPTION ?? r.desc ?? '';
      const image = safeImg(r.image ?? r.IMAGE ?? r.photo ?? r.Picture ?? '');
      const type = (r.type ?? r.TYPE ?? '').toString().toLowerCase();
      let links = Array.isArray(r.links) ? r.links : [];
      if (!links.length){
        const guess = r.GOUTER || r.LIEN_1_URL || r.URL || r.Link || r.lien;
        if (guess && typeof guess === 'string'){
          const m = guess.match(/https?:\/\/[^\s\]]+/);
          if (m) links = [{ text:'Acheter en ligne', url: m[0]}];
        }
      }
      return { name, latitude:lat, longitude:lon, image, description:desc, type, links };
    }

    function makeMap(DATA){
      // Fonds
      const osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap contributors' });
      const esri = L.tileLayer('https://{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { subdomains:['server','services'], attribution:'Tiles ¬© Esri' });

      const map = L.map('map', { zoomControl:true, tap:true, layers:[esri] }).setView([46.6, 2.2], 7);
      map.setMinZoom(5);
      map.setMaxZoom(12);

      // Labels des villes (CARTO) au-dessus du satellite
      map.createPane('labels');
      map.getPane('labels').style.zIndex = 650;
      map.getPane('labels').style.pointerEvents = 'none';
      const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png',
        { subdomains: 'abcd', maxZoom: 19, attribution: '¬© OSM ¬© CARTO', pane: 'labels' }).addTo(map);

      // S√©lecteur
      L.control.layers({ 'Classique': osm, 'Satellite': esri }, { 'Labels villes (CARTO)': labels }, { collapsed:true }).addTo(map);

      // === Ic√¥nes emoji en DivIcon ===
      function makeDivIcon(cls, emoji){
        return L.divIcon({
          className: '',
          html: `<div class="pin ${cls}"><span class="glyph">${emoji}</span></div>`,
          iconSize: [22, 32],      // 22 disque + ~10 de pointe
          iconAnchor: [11, 28],    // pointe centr√©e
          popupAnchor: [0, -24]
        });
      }
      const savoryIcon = makeDivIcon('savory', 'ü•®'); // Sal√©
      const sweetIcon  = makeDivIcon('sweet',  'üçØ'); // Sucr√©

      function guessType(it){
        if (it.type) return (''+it.type).toLowerCase();
        const t = ((it.name||'') + ' ' + (it.description||'')).toLowerCase();
        const sweet = ['sucre','sucr√©','chocolat','confiture','miel','biscuit','bonbon','patisserie','p√¢tisserie','g√¢teau','gateau','caramel'];
        for (let w of sweet) if (t.includes(w)) return 'sucre';
        return 'sale';
      }
      const iconFor = (it) => (guessType(it)==='sucre' ? sweetIcon : savoryIcon);

      // Marqueurs
      const markers = [];
      DATA.forEach(it => {
        const linksHTML = Array.isArray(it.links) && it.links.length
          ? it.links.map(l => `<a href="${l.url}" target="_blank" rel="nofollow sponsored noopener noreferrer">${l.text||'Acheter en ligne'} ‚Üó</a>`).join(' ¬∑ ')
          : '';
        const html = `<div style="width:240px">
          <div style="font-weight:600">${it.name||''} ${guessType(it)==='sucre'
            ? '<span style="background:#fde68a;color:#92400e;padding:2px 6px;border-radius:8px;font-size:10px;margin-left:6px;">Sucr√©</span>'
            : '<span style="background:#bfdbfe;color:#1e3a8a;padding:2px 6px;border-radius:8px;font-size:10px;margin-left:6px;">Sal√©</span>'}</div>
          ${it.image?`<img src="${safeImg(it.image)}" alt="" style="width:100%;height:140px;object-fit:cover;border-radius:10px;margin:6px 0" onerror="this.style.display='none'">`:''}
          <div style="font-size:12px;color:#6b7280;line-height:1.3">${it.description||''}</div>
          ${linksHTML?`<p style="margin:6px 0 0 0;">${linksHTML}</p>`:''}
        </div>`;
        const m = L.marker([it.latitude, it.longitude], { icon: iconFor(it) }).bindPopup(html).addTo(map);
        markers.push(m);
      });

      // Fit sur la m√©tropole uniquement (retombe sur tous les points si besoin)
      function isMetro(lat, lon) { return lat >= 41.0 && lat <= 51.5 && lon >= -5.5 && lon <= 10.5; }
      const metroMarkers = markers.filter(m => { const ll = m.getLatLng(); return isMetro(ll.lat, ll.lng); });
      if (metroMarkers.length) {
        const grp = L.featureGroup(metroMarkers);
        map.fitBounds(grp.getBounds().pad(0.2));
      } else if (markers.length) {
        const grp = L.featureGroup(markers);
        map.fitBounds(grp.getBounds().pad(0.2));
      }

      // Liste + recherche
      const listEl = document.getElementById('list'), qEl=document.getElementById('q'), clearBtn=document.getElementById('clearBtn');
      function render(rows){
        listEl.innerHTML=''; rows.forEach(it => {
          const div=document.createElement('div'); div.className='card';
          div.innerHTML = `<img class="thumb" src="${safeImg(it.image)||''}" alt="" onerror="this.style.display='none'"><div><div class="title">${it.name||''}</div><div class="desc">${(it.description||'').slice(0,160)}${(it.description||'').length>160?'‚Ä¶':''}</div></div>`;
          div.onclick = ()=>{ map.setView([it.latitude, it.longitude], 9); };
          listEl.appendChild(div);
        });
      }
      function doFilter(){
        const q=(qEl.value||'').toLowerCase().trim();
        const rows = !q ? DATA : DATA.filter(it => (it.name||'').toLowerCase().includes(q) || (it.description||'').toLowerCase().includes(q));
        render(rows);
      }
      qEl.addEventListener('input', doFilter);
      clearBtn.addEventListener('click', ()=>{ qEl.value=''; doFilter(); });

      doFilter();
      dbg.textContent = DATA.length + ' √©l√©ment(s) charg√©s';
    }

    waitForData().then(raw => {
      const DATA = (Array.isArray(raw) ? raw : []).map(normalizeRow).filter(Boolean);
      makeMap(DATA);
    }).catch(err => {
      dbg.textContent = "0 √©l√©ment ‚Äî FULL_DATA non trouv√©. V√©rifie que /data.js d√©finit `window.FULL_DATA = [...]`";
      console.error(err);
    });
  })();
  </script>
</body>
</html>
